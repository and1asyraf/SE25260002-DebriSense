<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debris Reports - Admin | DebriSense</title>
    
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_pages.css') }}">
</head>
<body class="admin-page">
    <!-- Top Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <a href="{{ url_for('admin_dashboard') }}">
                    <img src="{{ url_for('static', filename='img/debrisenseLogo.png') }}" alt="DebriSense Logo">
                </a>
                <span class="admin-badge">Admin</span>
            </div>
            <div class="navbar-actions">
                <a href="{{ url_for('admin_dashboard') }}" class="navbar-btn">Dashboard</a>
                <a href="{{ url_for('admin_logout') }}" class="navbar-btn logout-btn">Logout</a>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="admin-content">
        <div class="page-header">
            <h1>ðŸ“‹ Debris Reports</h1>
            <p>Review and manage debris sighting reports from NGOs</p>
        </div>
        
        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-status="all">All Reports</button>
            <button class="filter-tab" data-status="pending">Pending</button>
            <button class="filter-tab" data-status="reviewed">Reviewed</button>
            <button class="filter-tab" data-status="resolved">Resolved</button>
        </div>
        
        <!-- Reports Table -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>NGO</th>
                        <th>River</th>
                        <th>Debris Type</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reports-tbody">
                    {% for report in reports %}
                    <tr data-status="{{ report.status }}">
                        <td>{{ report.id }}</td>
                        <td>{{ report.user.ngo_name if report.user else 'Unknown' }}</td>
                        <td>{{ report.river.name if report.river else 'Unknown' }}</td>
                        <td>{{ report.debris_type }}</td>
                        <td>{{ report.estimated_amount }}</td>
                        <td>{{ report.reported_at.strftime('%Y-%m-%d') if report.reported_at else '' }}</td>
                        <td>
                            <span class="status-badge status-{{ report.status }}">{{ report.status }}</span>
                        </td>
                        <td>
                            <button class="btn-action" onclick="viewReport({{ report.id }})">View</button>
                            <button class="btn-action btn-primary" onclick="reviewReport({{ report.id }})">Review</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- View Report Modal -->
    <div class="modal" id="view-report-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Report Details</h2>
                <button class="close-modal" onclick="closeModal('view-report-modal')">Ã—</button>
            </div>
            <div class="modal-body" id="report-details">
                <!-- Filled by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Review Report Modal -->
    <div class="modal" id="review-report-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Review Report</h2>
                <button class="close-modal" onclick="closeModal('review-report-modal')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="review-form">
                    <input type="hidden" id="review-report-id">
                    
                    <div class="form-group">
                        <label>Update Status</label>
                        <select id="review-status" required>
                            <option value="pending">Pending</option>
                            <option value="reviewed">Reviewed</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Admin Notes</label>
                        <textarea id="review-notes" rows="4" placeholder="Add notes about this report..."></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('review-report-modal')">Cancel</button>
                        <button type="submit" class="btn-primary">Save Review</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <span class="toast-message"></span>
    </div>
    
    <script>
        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                const status = this.dataset.status;
                document.querySelectorAll('#reports-tbody tr').forEach(row => {
                    if (status === 'all' || row.dataset.status === status) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
        
        // View report
        async function viewReport(id) {
            try {
                const response = await fetch(`/api/admin/reports`);
                const data = await response.json();
                const report = data.reports.find(r => r.id === id);
                
                if (report) {
                    document.getElementById('report-details').innerHTML = `
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>NGO:</label>
                                <span>${report.user_name || 'Unknown'}</span>
                            </div>
                            <div class="detail-item">
                                <label>River:</label>
                                <span>${report.river_name || 'Unknown'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Debris Type:</label>
                                <span>${report.debris_type}</span>
                            </div>
                            <div class="detail-item">
                                <label>Estimated Amount:</label>
                                <span>${report.estimated_amount}</span>
                            </div>
                            <div class="detail-item">
                                <label>Sighting Date:</label>
                                <span>${report.sighting_date || 'Not specified'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Reported At:</label>
                                <span>${report.reported_at}</span>
                            </div>
                            ${report.description ? `
                            <div class="detail-item full-width">
                                <label>Description:</label>
                                <p>${report.description}</p>
                            </div>
                            ` : ''}
                            ${report.photo ? `
                            <div class="detail-item full-width">
                                <label>Photo:</label>
                                <img src="/static/img/reports/${report.photo}" alt="Report Photo" class="report-photo">
                            </div>
                            ` : ''}
                            ${report.admin_notes ? `
                            <div class="detail-item full-width">
                                <label>Admin Notes:</label>
                                <p class="admin-notes">${report.admin_notes}</p>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    openModal('view-report-modal');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Review report
        function reviewReport(id) {
            document.getElementById('review-report-id').value = id;
            openModal('review-report-modal');
        }
        
        // Submit review
        document.getElementById('review-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('review-report-id').value;
            const status = document.getElementById('review-status').value;
            const notes = document.getElementById('review-notes').value;
            
            try {
                const response = await fetch(`/api/admin/reports/${id}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, admin_notes: notes })
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Report reviewed successfully!');
                    closeModal('review-report-modal');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || 'Error reviewing report', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error reviewing report', 'error');
            }
        });
        
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.querySelector('.toast-message').textContent = message;
            toast.style.background = type === 'success' ? '#28a745' : '#dc3545';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>

